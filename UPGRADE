This file contains upgrade instructions between different versions of jabberd2.

* 2.1.15 to 2.1.16 upgrade:

What had change:
- Offline storage does not store headline messages by default
- XEP-0157: Contact Addresses for XMPP Services

If you want to store headline messages in offlinestorage, enable
<storeheadlines/> in sm.xml. See etc/sm.xml.dist for reference.
If you want to set XEP-0157: Contact Addresses please see
etc/sm.xml.dist discovery.serverinfo section for example configuration
to include in sm.xml.


* 2.1.14 to 2.1.15 upgrade:

Only bug and compilation fixes. No configuration changes needed.


* 2.1.13 to 2.1.14 upgrade:

What had change:
- Oracle authreg backend

You may use Oracle backend to store your user data too. See c2s.xml.dist.


* 2.1.12 to 2.1.13 upgrade:

Only bug and compilation fixes. No configuration changes needed.


* 2.1.11 to 2.1.12 upgrade:

What had change:
- PQconnectdb PostgreSQL connection method
- using pg_config to find PostgreSQL

For the PQconnectdb see <conninfo/> in etc/c2s.xml.dist and etc/sm.xml.dist.
You may add --enable-pgsql=/path/to/pg_config to ./configure to get PostgreSQL
paths using pg_config.


* 2.1.10 to 2.1.11 upgrade:

Only bug and compliance fixes. No configuration changes needed.


* 2.1.9 to 2.1.10 upgrade:

What had change:
- configure SASL backend fallback removed
- user roster items limit support

If you want to use other than GnuSASL backend for SASL, you need to enforce it
by --with-sasl=BACKEND option to ./configure. There is no fallback anymore,
because other backends are not supported and mostly do not work.
If you want to limit user roster items, please see etc/sm.xml.dist for reference.


* 2.1.8 to 2.1.9 upgrade:

What had change:
- logging formats
- oob redirection during registration

If you use log analysers please note that c2s and s2s connect messages have
now a "TLS negotiated" indicator at the end. For s2s it was "SSL negotiated".
c2s disconnection message now has user JID included.
If you want to use oob redirection during registration, please see
etc/c2s.xml.dist for reference.


* 2.1.7 to 2.1.8 upgrade:

What had change:
- SASL backend selection method

During ./configure use --with-sasl=BACKEND instead of --enable-gsasl
and --enable-cyrus.


* 2.1.6 to 2.1.7 upgrade:

What had change:
- MySQL connection defaults to UTF-8 now
- Removed support for ZeroK authentication

Please make sure that the encoding of the data in your MySQL DB is UTF-8
or is convertable by MySQL to UTF-8.
You may remove the 'token', 'sequence' and 'hash' columns in authreg table.


* 2.1.5 to 2.1.6 upgrade:

What had change:
- implemented XEP-0199: XMPP ping
- sysconfdir isn't changed to .../etc/jabberd anymore
- SASL backend is now GnuSASL by default with Cyrus as an alternative
- configure.in was renamed to configure.ac
- strndup() and timegm() implementations in subst/
- PATH_MAX definition added when necessary

Add <module>iq-ping</module> to in-sess and pkt-sm chains in sm.xml.
You need to explicitly set --sysconfdir with jabberd subdir if you want to.
You need to --disable-gsasl and --enable-cyrus if you need to use Cyrus SASL.
Remove all source dependant patches for missing functions if you have ones.


* 2.1.4 to 2.1.5 upgrade:

What had change:
- auth/reg/storage modules are now loaded dynamically at runtime
- MySQL storage backend is not enabled by default

Dynamic modules should run out of box once installed (make install).
If you need to configure other than the compiled-in path for it, please refer
to the c2s.xml.dist and sm.xml.dist for a proper <path/> option.
You will need to explicitly --enable-mysql during ./configure if you want to
use MySQL backends.


* 2.1.3 to 2.1.4 upgrade:

What had change:
- full SQLite support
- PostgreSQL NULL parameters handling
- more than one LDAP server support
- new LDAP append-realm setting
- correct CA chain handling

Please refer to sm.xml.dist and c2s.xml.dist for new config sections and add
them to your config files.
Please read these example files to see how to setup your CA chain correctly.
You may also remove cachain option from c2s.xml.
You may remove hostname form PostgreSQL setup to access it via unix socket.


* 2.1 to 2.1.3 upgrade:

What had change:
- c2s.xml added <ssl-mechanisms/> section
- c2s PAM authenticator now handles realm setting
- libjabberd moved from /usr/lib to /usr/lib/jabberd
- removed bootstrap script - use: autoreconf --install if you build from sources

If you want to use new SSL aware auth mechanizms please merge <ssl-mechanisms/>
section of c2s.xml.dist into your c2s.xml config file.
Remove any realm setting for PAM authenticated domains or setup your PAM system
to handle additional realms.
If you use modules.path in sm.xml, add .../jabberd/ at the end.


* 2.0 to 2.1 upgrade:

What had change:
- c2s.xml local/id syntax:
- DB schema
- amp and status modules
- CyrusSASL usage


Upgrade:

Basically all <local/> subitems and registration options from section
<register/> are configurable per-realm now. So you need to move pemfile,
verify-mode, require-starttls to <id/> attributes.
You may also use subitems of <local/> as before, and these will be used
for legacy port 5223 SSL wrapper.

Options require-starttls, register-enable and password-change ale boolean.
These are enabled if set to anything. 'true' seems reasonable for clarity.
WARNING: Setting 'false' doesn't disable it!!!

When you disabled new registrations for a realm not setting register-enable,
you may wish to set password-change to enable users to change password.

For new options like httpforward, see example c2s.xml for reference.


DB changes:
You need to add the following fields to the "vcard" table:

ALTER TABLE vcard ADD COLUMN "tz" text;
ALTER TABLE vcard ADD COLUMN "n-middle" text;
ALTER TABLE vcard ADD COLUMN "n-prefix" text;
ALTER TABLE vcard ADD COLUMN "n-suffix" text;
ALTER TABLE vcard ADD COLUMN "n-prefx" text;
ALTER TABLE vcard ADD COLUMN "n-suffix" text;
ALTER TABLE vcard ADD COLUMN "adr-street" text;
ALTER TABLE vcard ADD COLUMN "adr-extadd" text;
ALTER TABLE vcard ADD COLUMN "adr-pobox" text;
ALTER TABLE vcard ADD COLUMN "adr-locality" text;
ALTER TABLE vcard ADD COLUMN "adr-region" text;
ALTER TABLE vcard ADD COLUMN "adr-pcode" text;
ALTER TABLE vcard ADD COLUMN "adr-country" text;
ALTER TABLE vcard ADD COLUMN "geo-lat" text;
ALTER TABLE vcard ADD COLUMN "geo-lon" text;
ALTER TABLE vcard ADD COLUMN "org-orgname" text;
ALTER TABLE vcard ADD COLUMN "agent-extval" text;
ALTER TABLE vcard ADD COLUMN "sort-string" text;
ALTER TABLE vcard ADD COLUMN "desc" text;
ALTER TABLE vcard ADD COLUMN "note" text;
ALTER TABLE vcard ADD COLUMN "photo-type" text;
ALTER TABLE vcard ADD COLUMN "photo-binval" text;
ALTER TABLE vcard ADD COLUMN "photo-extval" text;
ALTER TABLE vcard ADD COLUMN "logo-type" text;
ALTER TABLE vcard ADD COLUMN "logo-binval" text;
ALTER TABLE vcard ADD COLUMN "logo-extval" text;
ALTER TABLE vcard ADD COLUMN "sound-phonetic" text;
ALTER TABLE vcard ADD COLUMN "sound-binval" text;
ALTER TABLE vcard ADD COLUMN "sound-extval" text;
ALTER TABLE vcard ADD COLUMN "key-type" text;
ALTER TABLE vcard ADD COLUMN "key-cred" text;
ALTER TABLE vcard ADD COLUMN "rev" text;

and create table "status":

CREATE TABLE "status" (
    "collection-owner" text PRIMARY KEY,
    "object-sequence" bigint,
    "status" text NOT NULL,
    "show" text,
    "last-login" int DEFAULT '0',
    "last-logout" int DEFAULT '0' );

NOTE: PostgreSQL schema was greatly improved as a whole.
It might be a good idea to dump your data (as INSERTS), recreate DB from
new schema and import data back again.


New modules: amp and status

In order for amp and status session manager modules to work, you need to
add them to appropriate chains in sm.xml and set their configuration options.
Chains needed to be updated: sess-start, sess-end, in-sess, pkt-sm, pkt-user
and user-delete. For details see sm.xml.dist.


CyrusSASL

You need working CyrusSASL installation. Please take care to include all
required auth modules. Especially cyrus-sasl-md5 and cyrus-sasl-plain.




Please report all errors of this howto to:
http://bugs.xiaoka.com/proj3

Tomasz Sterna <tomek@xiaoka.com>

